<!-- templates/registration/login.html -->
{% extends "base.html" %}

{% block head %}
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/3.2.6/css/fixedColumns.dataTables.min.css" crossorigin="anonymous">

{% endblock %}

{% block page_content %}

<div id="leaderboard" class="display">
</div>

{% if user.is_staff %}
<div>
    <a class="btn btn-primary mb-2" href="{% url 'rescore_all_races' %}" role="button">Rescore all Races</a>
</div>
{% endif %}

{% endblock %}

{% block javascript %}
<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.datatables.net/fixedcolumns/3.2.6/js/dataTables.fixedColumns.min.js" crossorigin="anonymous"></script>

<script>

var leaderboard_table = null;
var alleine_map = []

$(document).ready(function() {
    $.ajax({
            "url": '{% url 'leaderboard_data' %}',
            "success": function(json) {
                var tableHeaders = "<th>" + 'Tipper' + "</th>";
                var columns1 = [{ "name": "tipper", "data": "user.username", "className": "table-cell-tipper" }]

                tableHeaders += "<th>" + 'Total' + "</th>";
                columns1.push({"name": "total",  "data": "total", "className": "table_value table-cell-total" })

                tableHeaders += "<th>" + 'Start Pts' + "</th>";
                columns1.push({ "name": "preseason_adj", "data": "preseason_adj", "className": "table_value" })

                tableHeaders += "<th>" + 'Season Pts' + "</th>";
                columns1.push({ "name": "season_adj", "data": "season_adj", "className": "table_value"  })


                var cell_def_targets = []
                var no_tipp_cells = []

                var RACE_START_COL = 4

                $.each(json.races, function(i, val){
                    tableHeaders += "<th>" + val.short_name + "</th>";
                    var classes = "table-cell-race race-" + i + " table_value" 
                    var col_name = "races."+i
                    columns1.push({ "name": col_name, "data": col_name , "className": classes })
                    if (val.alleine != null) {
                        alleine_map.push({ 'column': col_name, "alleine": val.alleine })
                    }
                    cell_def_targets.push(RACE_START_COL + i)
                });

                $("#leaderboard").empty();
                $("#leaderboard").append('<table id="leaderboardTable" class="display" cellspacing="0" width="100%"><thead><tr>' + tableHeaders + '</tr></thead></table>');
                //$("#tableDiv").find("table thead tr").append(tableHeaders);  

                var  race_cell_def = {
					"targets": cell_def_targets,
					"render": function ( data, type, row, meta ) {
                        if (data.did_tipp != null & !data.did_tipp) {
                            no_tipp_cells.push ({ row: meta.row , col: meta.col})
                        }
                        return data.points;
					}
				};

                leaderboard_table = $('#leaderboardTable').dataTable( {
                    data: json.data,
                    columns: columns1,
                    scrollY:        false,
                    scrollX:        true,
                    scrollCollapse: true,
                    paging:         false,
                    searching: false,
                    fixedColumns:   {
                        leftColumns: 2,
                        rightColumns: 0
                    },
                    columnDefs: [race_cell_def],
                    order: [[ 1, 'desc' ]]
                });

                $.each(alleine_map, function(i, val) {
                    var row_index = leaderboard_table.DataTable().column('tipper:name').data().indexOf('joemolloy')
                    var cell = leaderboard_table.DataTable().cell( row_index, val.column+':name' ).node()
                    $(cell).addClass('alleine_im_sieg')

                })

                //add negative classes
                $.each(no_tipp_cells, function() {
                    var cell = leaderboard_table.DataTable().cell( this.row , this.col ).node()
                    $(cell).addClass('negative_pts')
                });

            },
            "dataType": "json"
        });
});
</script>

{% endblock %}
